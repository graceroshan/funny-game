
  window.innerHeight - groundEl.offsetHeight){ gameOver(); }
        if (bird.y < 0){ bird.y = 0; bird.vy = 0; }

        const birdRect = rect(birdEl);
        for (const p of pipes){
          const topRect = rect(p.top);
          const bottomRect = rect(p.bottom);
          if (intersects(birdRect, topRect) || intersects(birdRect, bottomRect)){ gameOver(); break; }
        }
        updateBirdDOM();
      }
      requestAnimationFrame(loop);
    }

    function startGame(){
      document.getElementById("gameOverBox").style.display = "none";
      overlay.style.display = "none";
      gameOverFlag = false;
      const music = document.getElementById("bgMusic");
      if (music.paused) music.play();
      pipes.forEach(p=>{p.top.remove();p.bottom.remove();});
      pipes = [];
      bird = { x: window.innerWidth * 0.3, y: window.innerHeight * 0.4, vy: 0 };
      score = 0;
      scoreEl.textContent = score;
      lastTime = null;
      spawnTimer = 0;
      running = true;
      updateBirdDOM();
    }

    function gameOver(){
      running = false;
      gameOverFlag = true;
      document.getElementById("bgMusic").pause();

      let highScore = localStorage.getItem('flappyHighScore') || 0;
      if (score > highScore){ highScore = score; localStorage.setItem('flappyHighScore', highScore); }
      document.getElementById("currentScore").textContent = score;
      document.getElementById("bestScore").textContent = highScore;

      document.getElementById("gameOverBox").style.display = "block";
      const snd = document.getElementById("gameOverSound");
      snd.currentTime = 0;
      snd.play();
    }

    function flap(){
      if (!running || gameOverFlag) return;
      bird.vy = FLAP_V;
      birdEl.style.transform = 'rotate(-20deg)';
      setTimeout(()=>updateBirdDOM(),80);
    }

    // Start game with Enter
    window.addEventListener('keydown', e=>{
      if (e.code === 'Enter' && !running && !gameOverFlag){
        startGame();
      }
      if ((e.code === 'Space' || e.code === 'ArrowUp') && running){
        e.preventDefault();
        flap();
      }
    });

    game.addEventListener('pointerdown', ()=>{
      if (running && !gameOverFlag) flap();
    });

    // Restart only when button clicked
    restartBtn.addEventListener('click', ()=>{
      startGame();
    });

    updateBirdDOM();
    requestAnimationFrame(loop);
  </script>
</body>
</html>

